<!DOCTYPE html>
<html lang="pl">
<head>
    <meta charset="UTF-8">
    <title>Panel Uniwersytetu</title>
    <link rel="icon" href="../images/uwm-logo.jpg" type="image/png">
    <style>
        body { font-family: sans-serif; max-width: 800px; margin: 0 auto; padding: 20px; }
        .form-group { margin-bottom: 15px; border: 1px solid #ddd; padding: 15px; background: #f9f9f9; }
        input, textarea { width: 100%; margin-bottom: 10px; padding: 8px; box-sizing: border-box;}
        button { background: #28a745; color: white; border: none; padding: 10px 20px; cursor: pointer; }
        
        /* WyglƒÖd pojedynczego artyku≈Çu */
        .artykul { border-bottom: 1px solid #ccc; padding: 20px 0; display: flex; gap: 20px; }
        .artykul img { max-width: 150px; height: auto; object-fit: cover; }
        #lista-artykulow{
            max-height: 50vh;
            overflow-y: scroll;
        }

    </style>
    <script src="../scripts/admin_auth.js"></script>
</head>
<body>

<h1>ZarzƒÖdzanie Aktualno≈õciami</h1>

<div class="form-group">
    <h3>Dodaj nowy wpis</h3>
    <input type="text" id="naglowek" placeholder="Tytu≈Ç artyku≈Çu">
    <input type="file" id="zdjecieInput" accept="image/*">
    <textarea id="tresc" rows="4" placeholder="Tre≈õƒá artyku≈Çu..."></textarea>
    <button onclick="dodajArtykul()">Opublikuj</button>
</div>

<div id="lista-artykulow"></div>

<script>
    // 1. WY≈öWIETLANIE (Tylko przycisk USU≈É)
    async function pobierzArtykuly() {
        try {
            const response = await fetch('/api/aktualnosci');
            const data = await response.json();
            
            const lista = document.getElementById('lista-artykulow');
            lista.innerHTML = ''; 

            if(data.length === 0) {
                lista.innerHTML = '<p>Brak artyku≈Ç√≥w.</p>';
                return;
            }

            data.forEach(art => {
                const div = document.createElement('div');
                div.className = 'artykul';
                div.style = "border-bottom: 1px solid #ccc; padding: 15px; display: flex; justify-content: space-between; align-items: start;";
                
                div.innerHTML = `
                    <div style="flex: 1; padding-right: 20px;">
                        <h3 style="margin: 0 0 10px 0;">${art.naglowek}</h3>
                        <p style="margin: 0 0 10px 0;">${art.tresc}</p>
                        ${art.zdjecieUrl ? `<img src="${art.zdjecieUrl}" style="max-width: 150px; border-radius: 5px;">` : ''}
                    </div>
                    <div>
                        <button onclick="window.usunArtykul('${art._id}')" style="background: red; color: white; border: none; padding: 5px 10px; cursor: pointer; border-radius: 4px;">Usu≈Ñ</button>
                    </div>
                `;
                lista.appendChild(div);
            });
        } catch (e) {
            console.error(e);
        }
    }

    // 2. DODAWANIE
    async function dodajArtykul() {
        const naglowek = document.getElementById('naglowek').value;
        const tresc = document.getElementById('tresc').value;
        const plikInput = document.getElementById('zdjecieInput');

        const formData = new FormData();
        formData.append('naglowek', naglowek);
        formData.append('tresc', tresc);
        if (plikInput.files.length > 0) {
            formData.append('zdjecie', plikInput.files[0]);
        }

        const response = await fetch('/api/aktualnosci', { method: 'POST', body: formData });

        if (response.ok) {
            alert('Dodano artyku≈Ç!');
            document.getElementById('naglowek').value = '';
            document.getElementById('tresc').value = '';
            document.getElementById('zdjecieInput').value = '';
            pobierzArtykuly();
        } else {
            alert('B≈ÇƒÖd dodawania.');
        }
    }

    // 3. USUWANIE
    window.usunArtykul = async function(id) {
        if(!confirm("UsunƒÖƒá ten wpis?")) return;
        
        const res = await fetch(`/api/aktualnosci/${id}`, { method: 'DELETE' });
        if(res.ok){
            pobierzArtykuly();
        } else {
            alert("B≈ÇƒÖd usuwania");
        }
    }

    // Start
    pobierzArtykuly();
</script>
<hr>
<div class="dodaj-studenta-sekcja">
    <h3>Dodaj Nowego U≈ºytkownika (Studenta)</h3>
    <form id="addStudentForm">
        
        <label for="login">Login (Wymagany):</label>
        <input type="text" id="login" name="login" required>

        <label for="haslo">Has≈Ço (Wymagane):</label>
        <input type="password" name="haslo" id="haslo">
            <br>
        <label for="imie">Imiƒô:</label>
        <input type="text" id="imie" name="imie">

        <label for="nazwisko">Nazwisko:</label>
        <input type="text" id="nazwisko" name="nazwisko">

        <label for="klasa">Klasa (Wymagana):</label>
        <input type="text" id="klasa" name="klasa" required>

        <label for="zdjecieURL">URL Zdjƒôcia (Opcjonalny, Domy≈õlny: awatar.png):</label>
        <input type="text" id="zdjecieURL" name="zdjecieURL" placeholder="np. /images/jan-kowalski.png">
        <button type="submit" onclick="addUser()">Dodaj Studenta</button>
        <p id="message"></p>
    </form>
</div>

<div class="users-management-container">
        <div class="header-tools">
            <h2>ZarzƒÖdzanie U≈ºytkownikami</h2>
            <input type="text" id="userSearch" placeholder="Szukaj po nazwisku lub loginie..." onkeyup="filtrujUzytkownikow()">
        </div>

        <div class="table-wrapper">
            <table class="users-table">
                <thead>
                    <tr>
                        <th>Imiƒô i Nazwisko</th>
                        <th>Login (Indeks)</th>
                        <th>Klasa / Rola</th>
                        <th>Akcje</th>
                    </tr>
                </thead>
                <tbody id="users-table-body" style="max-height: 200px; overflow-y: scroll;">
                    </tbody>
            </table>
        </div>
    </div>

    <div id="editModal" class="modal-overlay">
        <div class="modal-content">
            <h3>Edytuj U≈ºytkownika</h3>
            
            <input type="hidden" id="edit_id"> 
            
            <label>Imiƒô</label>
            <input type="text" id="edit_imie">
            
            <label>Nazwisko</label>
            <input type="text" id="edit_nazwisko">
            
            <label>Login</label>
            <input type="text" id="edit_login">
            
            <label>Klasa / Rola</label>
            <select id="edit_klasa">
                <option value="szlachta" style="font-weight: bold; color: purple;">üëë Szlachta (Admin)</option>
                
                <option value="nauczyciel">üéì Nauczyciel</option>
                
                <optgroup label="Klasy I stopnia">
                    <option value="IO1">IO1 (Informatyka Og√≥lna 1)</option>
                    <option value="IO2">IO2 (Informatyka Og√≥lna 2)</option>
                    <option value="IO3">IO3 (Informatyka Og√≥lna 3)</option>
                </optgroup>

            </select>
            <label>Status Studenta</label>
            <select id="edit_status" style="width: 100%; padding: 10px; margin-top: 5px; margin-bottom: 15px;">
                <option value="aktywny">üü¢ Aktywny</option>
                    <option value="urlop">üü° Urlop Dzieka≈Ñski</option>
                    <option value="absolwent">üéì Absolwent</option>
                    <option value="skre≈õlony">üî¥ Skre≈õlony</option>
            </select>
            <label>Zdjƒôcie profilowe</label>
            <input type="file" id="edit_zdjecie_plik" accept="image/*" style="margin-bottom: 10px;">
            <p style="font-size: 12px; color: gray;">Zostaw puste, aby zachowaƒá obecne zdjƒôcie.</p>
                    
            <img id="edit_preview" src="" style="width: 50px; height: 50px; border-radius: 50%; object-fit: cover; display: none; margin-bottom: 10px;">
    
            <div class="modal-actions">
                <button class="btn-cancel" onclick="zamknijModal()">Anuluj</button>
                <button class="btn-save" onclick="zapiszZmiany()">Zapisz Zmiany</button>
            </div>
        </div>
    </div>

    <script src="admin-users.js"></script>

<script>

    async function addUser() {
        const login = document.getElementById('login').value;
        const haslo = document.getElementById('haslo').value;
        const imie = document.getElementById('imie').value;
        const nazwisko = document.getElementById('nazwisko').value;
        const klasa = document.getElementById('klasa').value;
        const zdjecieURL = document.getElementById('zdjecieURL').value;

        const response = await fetch('/api/register',{

            method: 'POST',
            headers: { 'Content-Type': 'application/json'},
            body: JSON.stringify({ login, haslo, imie, nazwisko, zdjecieURL, klasa})
        });
        if(response.ok){
            alert('Dodano uzytkownika');

        }else{
            alert('B≈ÇƒÖd! Nie udalo sie dodaj uzytkownika.');
        }
        
    }

</script>

<hr>
<hr>

<div class="form-group">
    <h3 id="z_form_title">Dodaj zajƒôcia</h3>

    <input type="hidden" id="z_id">

    <input type="text" id="z_nazwa" placeholder="Nazwa zajƒôƒá">
    <input type="text" id="z_prowadzacy" placeholder="ProwadzƒÖcy">
    <input type="text" id="z_dzien" placeholder="Dzie≈Ñ (np. Poniedzia≈Çek)">
    <input type="time" id="z_od">
    <input type="time" id="z_do">
    <input type="text" id="z_sala" placeholder="Sala">
    <input type="text" id="z_grupa" placeholder="Grupa (np. 1A / lab1)">
    <input type="text" id="z_typ" placeholder="Typ zajƒôƒá (np. Wyk≈Çad / Lab)">


    <button onclick="zapiszZajecia()">Zapisz</button>
    <button onclick="anulujEdycje()" style="background:#999; display:none" id="cancelBtn">
        Anuluj
    </button>
</div>

<div id="lista-zajec"></div>


<script>
let edytowaneId = null;

async function pobierzZajecia() {
    const res = await fetch('/api/zajecia');
    const data = await res.json();

    const lista = document.getElementById('lista-zajec');
    lista.innerHTML = '<h3>Lista zajƒôƒá</h3>';

    data.forEach(z => {
    const div = document.createElement('div');
    div.className = 'artykul';
    div.innerHTML = `
        <div style="flex:1">
            <strong>${z.nazwa}</strong><br>
            ${z.dzien} ${z.godzinaOd}‚Äì${z.godzinaDo}<br>
            sala ${z.sala} | grupa ${z.grupaZaj}<br>
            <small>${z.prowadzacy}</small><br><br>
            <button class="editBtn">‚úèÔ∏è Edytuj</button>
            <button class="deleteBtn" style="background:#dc3545">üóëÔ∏è Usu≈Ñ</button>
        </div>
    `;
    lista.appendChild(div);

    // Eventy
    div.querySelector('.editBtn').addEventListener('click', () => edytujZajecia(z));
    div.querySelector('.deleteBtn').addEventListener('click', () => usunZajecia(z._id));
});

}


// ‚ûï POST / ‚úèÔ∏è PUT
async function zapiszZajecia() {
    const body = {
    nazwa: z_nazwa.value,
    prowadzacy: z_prowadzacy.value,
    dzien: z_dzien.value,
    godzinaOd: z_od.value,
    godzinaDo: z_do.value,
    sala: z_sala.value,
    grupaZaj: z_grupa.value,
    typ: z_typ.value // <-- nowy typ
};

    const method = edytowaneId ? 'PUT' : 'POST';
    const url = edytowaneId ? `/api/zajecia/${edytowaneId}` : '/api/zajecia';

    const res = await fetch(url, {
        method,
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(body)
    });

    if (res.ok) {
        alert(edytowaneId ? 'Zajƒôcia zaktualizowane ‚úèÔ∏è' : 'Dodano zajƒôcia ‚úÖ');
        wyczyscFormularz();
        pobierzZajecia();
    } else {
        alert('B≈ÇƒÖd zapisu ‚ùå');
    }
}


// ‚úèÔ∏è Edycja
function edytujZajecia(z) {
    edytowaneId = z._id;

    z_form_title.innerText = 'Edytuj zajƒôcia';
    cancelBtn.style.display = 'inline-block';

    z_nazwa.value = z.nazwa;
    z_prowadzacy.value = z.prowadzacy;
    z_dzien.value = z.dzien;
    z_od.value = z.godzinaOd;
    z_do.value = z.godzinaDo;
    z_sala.value = z.sala || '';
    z_grupa.value = z.grupaZaj || '';
    z_typ.value = z.typ || '';
}


// ‚ùå Anuluj
function anulujEdycje() {
    wyczyscFormularz();
}


// üóëÔ∏è DELETE
async function usunZajecia(id) {
    if (!confirm('Na pewno usunƒÖƒá zajƒôcia?')) return;

    await fetch(`/api/zajecia/${id}`, { method: 'DELETE' });
    pobierzZajecia();
}


// üßπ Reset
function wyczyscFormularz() {
    edytowaneId = null;
    z_form_title.innerText = 'Dodaj zajƒôcia';
    cancelBtn.style.display = 'none';

    ['z_nazwa','z_prowadzacy','z_dzien','z_od','z_do','z_sala','z_grupa']
        .forEach(id => document.getElementById(id).value = '');
}

pobierzZajecia();
</script>



</body>
</html>